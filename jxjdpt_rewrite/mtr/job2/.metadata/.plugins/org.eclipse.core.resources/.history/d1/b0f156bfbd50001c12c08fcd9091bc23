package com.sx.ldlsc.jxjdpt.common;

import java.io.UnsupportedEncodingException;
import java.lang.reflect.Field;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;
import java.net.URLDecoder;
import java.util.Collection;
import java.util.Map;

import com.sx.bean.AbsFormBean;
import com.sx.ldlsc.exception.LdlscExceptionUtils;

import net.sf.json.JSONObject;

/**
 * AjaxJson������
 * 
 * ������Action���Ajax���󷵻ص���ݽ���ͳһ����
 * 
 * @author limiao
 * @version 1.0
 */
public class AjaxJsonResult {

	/**
	 * �ɹ�������
	 */
	public static final int CODE_SUCCESS = 1;

	/**
	 * ʧ�ܷ�����
	 */
	public static final int CODE_ERROR = -1;

	/**
	 * ��½��ʱ������
	 */
	public static final int CODE_TIMEOUT = -2;

	/**
	 * ϵͳ�쳣������
	 */
	public static final int CODE_SYSEXCEP = -9;

	private int returnCode;// �����루1:�ɹ���-1:ʧ�ܣ�-2:��½��ʱ��-9:ϵͳ�쳣��

	private String returnMsg;// ������Ϣ

	private Object returnData = "";// �������

	private String pageCount;// ��ҳ��

	private String rowsCount;// ������

	private String startNum;// ��ʼ�к�

	public int getReturnCode() {
		return returnCode;
	}

	public String getReturnMsg() {
		return returnMsg;
	}

	public Object getReturnData() {
		return returnData;
	}

	public String getPageCount() {
		return pageCount;
	}

	public void setPageCount(String pageCount) {
		this.pageCount = pageCount;
	}

	public String getRowsCount() {
		return rowsCount;
	}

	public void setRowsCount(String rowsCount) {
		this.rowsCount = rowsCount;
	}

	public String getStartNum() {
		return startNum;
	}

	public void setStartNum(String startNum) {
		this.startNum = startNum;
	}

	/**
	 * ���췽��
	 * 
	 */
	public AjaxJsonResult() {
		this.returnCode = CODE_SUCCESS;
		this.returnMsg = "�����ɹ���";
	}

	/**
	 * ���췽��
	 * 
	 * @param returnCode
	 * @exception IllegalArgumentException
	 */
	public AjaxJsonResult(int returnCode) {
		if (returnCode != CODE_SUCCESS && returnCode != CODE_ERROR
				&& returnCode != CODE_TIMEOUT && returnCode != CODE_SYSEXCEP) {
			throw new IllegalArgumentException(
					"returnCode is not equals 1 or -1 or -2 or -9");
		}

		this.returnCode = returnCode;

		switch (returnCode) {
		case CODE_SUCCESS:
			this.returnMsg = "�����ɹ���";
			break;
		case CODE_ERROR:
			this.returnMsg = "����ʧ�ܣ�";
			break;
		case CODE_TIMEOUT:
			this.returnMsg = "��½��ʱ�������µ�½��";
			break;
		case CODE_SYSEXCEP:
			this.returnMsg = "ϵͳ�쳣��";
			break;
		}
	}

	/**
	 * ���ò����ɹ�
	 * 
	 */
	public void setOperSuc() {
		this.returnCode = CODE_SUCCESS;
		this.returnMsg = "�����ɹ���";
	}

	/**
	 * ���ò����ɹ�
	 * 
	 * @param returnData
	 */
	public void setOperSuc(Object returnData) {
		setOperSuc();
		setReturnData(returnData);
	}

	/**
	 * ���ò���ʧ��
	 * 
	 */
	public void setOperErr() {
		this.returnCode = CODE_ERROR;
		this.returnMsg = "����ʧ�ܣ�";
	}

	/**
	 * ���õ�½��ʱ
	 * 
	 */
	public void setLoginTimeOut() {
		this.returnCode = CODE_TIMEOUT;
		this.returnMsg = "��½��ʱ�������µ�½��";
	}

	/**
	 * ����ϵͳ�쳣
	 * 
	 * @param t
	 * @exception NullPointerException
	 */
	public void setSysException(Throwable t) {
		if (t == null) {
			throw new NullPointerException("t is null");
		}
		this.returnCode = CODE_SYSEXCEP;
		this.returnMsg = "ϵͳ�쳣��" + LdlscExceptionUtils.getErrorCode(t);
	}

	/**
	 * ����ϵͳ�쳣
	 * 
	 * @param excepMsg
	 *            �쳣����
	 * @exception NullPointerException
	 */
	public void setSysException(String excepMsg) {
		if (excepMsg == null) {
			throw new NullPointerException("t is null");
		}
		this.returnCode = CODE_SYSEXCEP;
		this.returnMsg = "ϵͳ�쳣��" + excepMsg;
	}

	/**
	 * ���÷�����ͷ�����Ϣ
	 * 
	 * @param returnCode
	 * @param returnMsg
	 * @exception NullPointerException
	 */
	public void setCodeAndMsg(int returnCode, String returnMsg) {
		if (returnMsg == null) {
			throw new NullPointerException("returnMsg is null");
		}
		this.returnCode = returnCode;
		this.returnMsg = returnMsg;
	}

	/**
	 * ���÷������
	 * 
	 * @param returnData
	 * @exception NullPointerException
	 */
	public void setReturnData(Object returnData) {
		if (returnData == null) {
			throw new NullPointerException("returnData is null");
		}
		this.returnData = returnData;
	}

	/**
	 * ���JSON
	 * 
	 * @return String
	 */
	public static String getJson(AjaxJsonResult ajr) {
		String jsonStr = String.valueOf(JSONObject.fromObject(ajr));

		Object data = ajr.getReturnData();
		if (data instanceof Collection) {
			((Collection) data).clear();
		} else if (data instanceof Map) {
			((Map) data).clear();
		}

		return jsonStr;
	}

	/**
	 * ����
	 * 
	 * @param formbean
	 * @throws IllegalArgumentException
	 * @throws IllegalAccessException
	 * @throws InvocationTargetException
	 * @throws SecurityException
	 * @throws NoSuchMethodException
	 * @throws UnsupportedEncodingException
	 */
	public static void decode(AbsFormBean formbean)
			throws IllegalArgumentException, IllegalAccessException,
			InvocationTargetException, SecurityException,
			NoSuchMethodException, UnsupportedEncodingException {
		Class clazz = formbean.getClass();

		Field[] fields = clazz.getDeclaredFields();
		for (int index = 0; index < fields.length; index++) {
			if (fields[index].getType() != String.class
					&& fields[index].getType() != String[].class) {
				continue;
			}

			String fieldName = fields[index].getName();
			String getMethodName = "get"
					+ fieldName.substring(0, 1).toUpperCase()
					+ fieldName.substring(1);
			String setMethodName = "set"
					+ fieldName.substring(0, 1).toUpperCase()
					+ fieldName.substring(1);
			Method getMethod = clazz.getMethod(getMethodName, new Class[] {});
			Object ret = getMethod.invoke(formbean, null);

			if (null == ret) {
				continue;
			}
			if (ret instanceof String) {
				String str = (String) ret;
				if ("".equals(ret)) {
					continue;
				}

				ret = URLDecoder.decode(str, "UTF-8");

				Method setMethod = clazz.getMethod(setMethodName,
						new Class[] { String.class });
				setMethod.invoke(formbean, new Object[] { ret });
			} else if (ret instanceof String[]) {
				String[] strs = (String[]) ret;
				if (strs.length == 0) {
					continue;
				}
				for (int i = 0; i < strs.length; i++) {
					if (null != strs[i] && !"".equals(strs[i])) {
						strs[i] = URLDecoder.decode(strs[i], "UTF-8");
					}
				}

				Method setMethod = clazz.getMethod(setMethodName,
						new Class[] { String[].class });
				setMethod.invoke(formbean, new Object[] { ret });
			}
		}
	}

	/**
	 * ����
	 * 
	 * @param str
	 * @return String
	 * @throws UnsupportedEncodingException
	 * @throws NullPointerException -
	 *             if str is null
	 */
	public static String decode(String str) throws UnsupportedEncodingException {
		if (str == null) {
			throw new NullPointerException("str is null");
		}

		if ("".equals(str)) {
			return "";
		}

		return URLDecoder.decode(str, "UTF-8");
	}

	/**
	 * ����
	 * 
	 * @param strArray
	 * @throws UnsupportedEncodingException
	 * @throws NullPointerException -
	 *             if strArray is null
	 */
	public static void decode(String[] strArray)
			throws UnsupportedEncodingException {
		if (strArray == null) {
			throw new NullPointerException("strArray is null");
		}

		for (int i = 0; i < strArray.length; i++) {
			String str = strArray[i];
			if (str == null) {
				continue;
			}
			if ("".equals(str)) {
				continue;
			}
			strArray[i] = URLDecoder.decode(str, "UTF-8");
		}
	}
}
